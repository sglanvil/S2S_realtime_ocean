/glade/u/home/ssfcst/JRA55-do/cesm-scripts/JRA_step1.sh ENTER
#trap '[[ $BASH_COMMAND != echo* ]] && $BASH_COMMAND' DEBUG
#-------------------------------------------------------------------------------
# LID=$(date +%y%m%d-%H%M%S)
# LOGFILE=$(pwd)/master.$YEAR.log.$LID


DATADIR=/glade/scratch/ssfcst/JRA55_data             # where input, output, & intermediate data is here
HOMEDIR=/glade/u/home/ssfcst//JRA55-do               # where the standard JRA55-do scripts are
SCRIPTDIR=/glade/u/home/ssfcst/JRA55-do/cesm-scripts # where the CESM wrapper scripts are

YEARs=2020    # start date: year 
MONTHs=1      # start date: month 
DAYs=1        # start date: day in month
ODAYs=1       # start date: ordinal day (day in year)

YEARe=2020    # end date: year -- ?  assume YEARs = YEARe
MONTHe=2      # end date: month 
DAYe=29       # end date: day in month
ODAYe=60      # end date: ordinal day
DATESTRe=2020-02-29 # end date: text string for netCDF file name

DATESTRc=20210106 # end date: text string for netCDF file name

YEARp=2020    # end date: year -- ?  assume YEARs = YEARp
MONTHp=3      # day after end date: month
DAYp=1        # day after end date: day
ODAYp=61      # day after end date: ordinal day

COMPILE=TRUE    # TRUE => compile code
DOWNLOAD=TRUE   # download ftp data

DO_STEP0=FALSE
DO_STEP1=TRUE 
DO_STEP2=FALSE
DO_STEP3=FALSE
DO_STEP4=FALSE
DO_STEP5=FALSE
DO_STEP6=FALSE
DO_STEP7=FALSE
DO_STEP8=FALSE
LOGFILE=${CASEDIR}/${0}.${LID}
echo "$0 LOGFILE = $LOGFILE"
/glade/u/home/ssfcst/JRA55-do/cesm-scripts/JRA_step1.sh LOGFILE = /glade/u/home/ssfcst/JRA55-do/cesmTEST202002//glade/u/home/ssfcst/JRA55-do/cesm-scripts/JRA_step1.sh.210106-170538
echo "$0 HOMEDIR = $LOGFILE"
/glade/u/home/ssfcst/JRA55-do/cesm-scripts/JRA_step1.sh HOMEDIR = /glade/u/home/ssfcst/JRA55-do/cesmTEST202002//glade/u/home/ssfcst/JRA55-do/cesm-scripts/JRA_step1.sh.210106-170538
#-------------------------------------------------------------------------------

echo "==========================================================================="
===========================================================================
echo "1. Acquire JRA-55 forecast data and pre-process it"
1. Acquire JRA-55 forecast data and pre-process it
echo "==========================================================================="
===========================================================================

echo " Download JRA55 forecast data ---------------------------------------------"
 Download JRA55 forecast data ---------------------------------------------
if [ $DOWNLOAD != "TRUE" ] ; then
   echo "Not downloading data -- assume it has already been acquired"
else
   DATA_SRC_DIR=/glade/collections/rda/data/ds628.8
#  for MONTH in 01 02 03 04 05 06 07 08 09 10 11 12 ; do
   for MONTH in                   07 08 09 10 11 12 ; do
      DATE_DIR=${YEARs}${MONTH}
   #  for FCST_DIR in fcst_phy2m ice fcst_surf fcst_phyland ; do  -- don't need phyland or ice ?
      for FCST_DIR in fcst_phy2m ice fcst_surf ; do
         cd $DATADIR/forcing/$FCST_DIR
         if [ ! -d $DATE_DIR ]; then mkdir $DATE_DIR ; fi
         cp -rpn $DATA_SRC_DIR/$FCST_DIR/$DATE_DIR/*   $DATE_DIR
   #     echo $(date +%y%m%d-%H%M%S)  lftp mirror -c  $DATADIR/$FCST_DIR/$DATE_DIR
   #     lftp -c "open -u jra06235,2rXw3TSf ds.data.jma.go.jp ; cd /JRA-55/Hist/Daily/$FCST_DIR ; mirror -c -P 3 $DATE_DIR ; exit "
   #     lftp -c "open -u jra06235,2rXw3TSf ds.data.jma.go.jp ; cd /JRA-55/Hist/Daily/$FCST_DIR/$DATE_DIR ; mget -c * "  -- too many processes
      done
   done
fi

#-----------------------------------------------------------------------------------------
echo " Decode GRIB and make flat binary -----------------------------------------"
 Decode GRIB and make flat binary -----------------------------------------
echo "tStamp: $(date +%y%m%d-%H%M%S)"
tStamp: 210106-170539
#-----------------------------------------------------------------------------------------

cd $HOMEDIR/extract_jra55
pwd
/glade/u/home/ssfcst/JRA55-do/extract_jra55

LOGFILE=$CASEDIR/process_year_last.log.$YEARe.$LID
time ./process_year_last.sh $YEARe $MONTHe $DAYe  >& $LOGFILE

real	2m34.850s
user	0m22.930s
sys	1m41.770s
#  input: DATADIR/forcing/fcst_phy2m,fcst_surf
# output: DATADIR/work/jra55fcst_3hr_TL319r

#-----------------------------------------------------------------------------------------
echo " Apply zonal 1-2-1 filter to winds ----------------------------------------"
 Apply zonal 1-2-1 filter to winds ----------------------------------------
echo "tStamp: $(date +%y%m%d-%H%M%S)"
tStamp: 210106-170813
#-----------------------------------------------------------------------------------------

cd $HOMEDIR/jra55_org_grid_calib
pwd
/glade/u/home/ssfcst/JRA55-do/jra55_org_grid_calib

if [ $COMPILE == "TRUE" ] ; then
   gmake filter_wind_interannual
fi
cd ../lib; make
make[1]: Entering directory `/glade/u/home/ssfcst/JRA55-do/lib'
ifort libmxe_para.F90 -c -convert big_endian -assume byterecl -o libmxe_para.o
ifort libmxe_calendar.F90 -c -convert big_endian -assume byterecl -o libmxe_calendar.o
ifort libmxe_trnsfrm.F90 -c -convert big_endian -assume byterecl -o libmxe_trnsfrm.o
ifort libmxe_io.F90 -c -convert big_endian -assume byterecl -o libmxe_io.o
ifort libmxe_grid.F90 -c -convert big_endian -assume byterecl -o libmxe_grid.o
ifort libmxe_topo.F90 -c -convert big_endian -assume byterecl -o libmxe_topo.o
ifort libmxe_grads.F90 -c -convert big_endian -assume byterecl -o libmxe_grads.o
ifort libmxe_stmrgn.F90 -c -convert big_endian -assume byterecl -o libmxe_stmrgn.o
ifort libmxe_ut.F90 -c -convert big_endian -assume byterecl -o libmxe_ut.o
ifort fruit/fruit_util.f90 -c -convert big_endian -assume byterecl -o fruit_util.o
ifort fruit/fruit.f90 -c -convert big_endian -assume byterecl -o fruit.o
ar rv libmxe.a libmxe_para.o libmxe_calendar.o libmxe_trnsfrm.o libmxe_io.o libmxe_grid.o libmxe_topo.o libmxe_grads.o libmxe_stmrgn.o libmxe_ut.o fruit.o fruit_util.o
ar: creating libmxe.a
a - libmxe_para.o
a - libmxe_calendar.o
a - libmxe_trnsfrm.o
a - libmxe_io.o
a - libmxe_grid.o
a - libmxe_topo.o
a - libmxe_grads.o
a - libmxe_stmrgn.o
a - libmxe_ut.o
a - fruit.o
a - fruit_util.o
make[1]: Leaving directory `/glade/u/home/ssfcst/JRA55-do/lib'
ifort -c -convert big_endian -assume byterecl  -I ../lib -o fileunmng.o src/file_mng/fileunmng.F90
ifort -c -convert big_endian -assume byterecl  -I ../lib -o fileocmng.o src/file_mng/fileocmng.F90
ifort -c -convert big_endian -assume byterecl  -I ../lib -o force_process.o src/force_process.F90
ifort -c -convert big_endian -assume byterecl  -I ../lib -o reduced_grid.o src/util/reduced_grid.F90
ar rv lib.a fileunmng.o fileocmng.o force_process.o reduced_grid.o
ar: creating lib.a
a - fileunmng.o
a - fileocmng.o
a - force_process.o
a - reduced_grid.o
ifort src/filter_wind_interannual.F90 -c -convert big_endian -assume byterecl -I ../lib  -o filter_wind_interannual.o
ifort filter_wind_interannual.o lib.a  -L ../lib -lmxe -o filter_wind_interannual
rm filter_wind_interannual.o

LOGFILE=$CASEDIR/filter_wind_interannual_latest_exec.log.$YEARs.$LID
time ./filter_wind_interannual_latest_exec.sh $YEARs $MONTHs $DAYs $YEARp $MONTHp $DAYp  >& $LOGFILE

real	0m23.208s
user	0m0.641s
sys	0m0.440s
#  input: DATADIR/work/jra55fcst_3hr_TL319r
# output: DATADIR/work/jra55fcst_filt_3hr_TL319  <- (link) DATADIR/work/jra55fcst_3hr_TL319

#-----------------------------------------------------------------------------------------
echo " Regrid from reduced TL319 to normal TL319 ---------------------------------"
 Regrid from reduced TL319 to normal TL319 ---------------------------------
echo "tStamp: $(date +%y%m%d-%H%M%S)"
tStamp: 210106-170849
#-----------------------------------------------------------------------------------------

cd $HOMEDIR/jra55_org_grid_product
pwd
/glade/u/home/ssfcst/JRA55-do/jra55_org_grid_product

if [ $COMPILE == "TRUE" ] ; then
   gmake make_red2reg
fi
ifort -c -convert big_endian -assume byterecl  -I ../lib -o fileunmng.o src/file_mng/fileunmng.F90
ifort -c -convert big_endian -assume byterecl  -I ../lib -o fileocmng.o src/file_mng/fileocmng.F90
ifort -c -convert big_endian -assume byterecl  -I ../lib -o reduced_grid.o src/util/reduced_grid.F90
ifort -c -convert big_endian -assume byterecl  -I ../lib -o distance_rad.o src/util/distance_rad.F90
ar rv lib.a fileunmng.o fileocmng.o reduced_grid.o distance_rad.o
ar: creating lib.a
a - fileunmng.o
a - fileocmng.o
a - reduced_grid.o
a - distance_rad.o
ifort src/make_red2reg.F90 -c -convert big_endian -assume byterecl  -I ../lib -o make_red2reg.o
ifort make_red2reg.o lib.a ../lib/libmxe.a  -L ../lib -lmxe -o make_red2reg
rm make_red2reg.o

echo "#--- regrid everything except wind ---"
#--- regrid everything except wind ---
LOGFILE=$CASEDIR/red2reg_exec_raw_v1_0.log.$YEARs.$LID
time           ./red2reg_exec_raw_v1_0.sh  $YEARs $YEARe $ODAYs $ODAYe >& $LOGFILE

real	3m13.806s
user	0m38.343s
sys	0m48.700s
echo "#--- regrid filtered wind ---"
#--- regrid filtered wind ---
LOGFILE=$CASEDIR/red2reg_exec_raw_v1_0_wind.log.$YEARs.$LID
time           ./red2reg_exec_raw_v1_0_wind.sh  $YEARs $YEARe $ODAYs $ODAYe >& $LOGFILE

real	0m46.542s
user	0m9.369s
sys	0m11.406s
#  input: DATADIR/work/jra55fcst_3hr_TL319r
#  input: DATADIR/work/jra55fcst_filt_3hr_TL319r
# output: DATADIR/work/jra55fcst_filt_3hr_TL319


# link: DATADIR/work/jra55fcst_3hr_TL319 -> DATADIR/work/jra55fcst_filt_3hr_TL319 (only wind is filtered)

echo ${0} "EXIT"
/glade/u/home/ssfcst/JRA55-do/cesm-scripts/JRA_step1.sh EXIT
