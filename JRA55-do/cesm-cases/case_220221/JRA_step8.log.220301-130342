/glade/u/home/ssfcst/JRA55-do/cesm-scripts/JRA_step8.sh ENTER
#trap '[[ $BASH_COMMAND != echo* ]] && $BASH_COMMAND' DEBUG

# LID=$(date +%y%m%d-%H%M%S)
# LOGFILE=$(pwd)/master.$YEAR.log.$LID
#-------------------------------------------------------------------------------

DATADIR=/glade/campaign/cesm/development/cross-wg/S2S/JRA55_data # work dir for input, output, intermediate data
HOMEDIR=/glade/u/home/ssfcst/JRA55-do                # root dir for all JRA55-do scripts (repo root dir)
SCRIPTDIR=/glade/u/home/ssfcst/JRA55-do/cesm-scripts # where the CESM wrapper scripts are

# -------------------- user only needs to specify "DATE" --------------------
DATE=2022-02-21                 # form: YYYYY-MM-DD

# -------------------- note, start date must always be January 1 --------------------
YEARs=$(date +%Y -d "$DATE")    	# start date: year
MONTHs=1                        	# start date: month
DAYs=1                          	# start date: day of month
ODAYs=1                         	# start date: ordinal day (day of year)
YEARe=$(date +%Y -d "$DATE")    	# end date: year
MONTHe=$(date +%m -d "$DATE")   	# end date: month
DAYe=$(date +%d -d "$DATE")     	# end date: day of month
ODAYe=$(date +%j -d "$DATE")    	# end date: ordinal day (day of year)
YEARp=$(date +%Y -d "$DATE + 1 day")    # day after end date: year
MONTHp=$(date +%m -d "$DATE + 1 day")   # day after end date: month
DAYp=$(date +%d -d "$DATE + 1 day")     # day after end date: day of month
DATESTRe=$YEARe$MONTHe$DAYe     	# end date: text string for netCDF file name
DATESTRc=$YEARe$MONTHe$DAYe     	# file creation date text string for netCDF file name

COMPILE=FALSE   			# TRUE => compile code (usually set to FALSE)
DOWNLOAD=TRUE				# download ftp data (usually set to TRUE)
DO_STEP0=FALSE
DO_STEP1=TRUE 
DO_STEP2=TRUE
DO_STEP3=TRUE
DO_STEP4=TRUE
DO_STEP5=TRUE
DO_STEP6=TRUE
DO_STEP7=TRUE
DO_STEP8=TRUE 
LOGFILE=${CASEDIR}/${0}.${LID}
echo "$0 LOGFILE = $LOGFILE"
/glade/u/home/ssfcst/JRA55-do/cesm-scripts/JRA_step8.sh LOGFILE = /glade/u/home/ssfcst/JRA55-do/cesm-cases/case_220221//glade/u/home/ssfcst/JRA55-do/cesm-scripts/JRA_step8.sh.220301-130342
echo "$0 HOMEDIR = $LOGFILE"
/glade/u/home/ssfcst/JRA55-do/cesm-scripts/JRA_step8.sh HOMEDIR = /glade/u/home/ssfcst/JRA55-do/cesm-cases/case_220221//glade/u/home/ssfcst/JRA55-do/cesm-scripts/JRA_step8.sh.220301-130342
#-------------------------------------------------------------------------------

echo "==========================================================================="
===========================================================================
echo "8 Create dataset product for input4MIPs "                
8 Create dataset product for input4MIPs 
echo "==========================================================================="
===========================================================================

#-----------------------------------------------------------------------------------------
echo " When updating data in the middle of a year -------------------------------"
 When updating data in the middle of a year -------------------------------
echo "tStamp: $(date +%y%m%d-%H%M%S)"
tStamp: 220301-130342
#-----------------------------------------------------------------------------------------

cd $HOMEDIR/for_mricom
pwd
/glade/u/home/ssfcst/JRA55-do/for_mricom

LOGFILE=$CASEDIR/make_mricom_latest.$LID
time ./make_mricom_latest.sh  $YEARs $ODAYe   >& $LOGFILE

real	1m9.455s
user	0m8.655s
sys	0m35.787s
#  input: .../linkdir/work/jra55fcst_filt_3hr_TL319       # slprs, brtmp, ice
#  input: .../linkdir/work/jra55fcst_v1_3_prod3_3hr_TL319 # tmp10m sph10m
#  input: .../linkdir/work/jra55fcst_v1_3_prod1_3hr_TL319 # u10m v10m
#  input: .../linkdir/work/jra55fcst_v1_3_rad2_3hr_TL319  # dswrf dlwrf v1_3 => const correction
#  input: .../linkdir/work/jra55fcst_v1_3_prcp2_3hr_TL319 # rain snow
# output: .../linkdir/products/version_1_5/grads (excluding rain data which was created in step 7)

#-----------------------------------------------------------------------------------------
echo " Intermediate netCDF data -------------------------------------------------"
 Intermediate netCDF data -------------------------------------------------
echo "tStamp: $(date +%y%m%d-%H%M%S)"
tStamp: 220301-130452
#-----------------------------------------------------------------------------------------

cd $HOMEDIR/for_omip
pwd
/glade/u/home/ssfcst/JRA55-do/for_omip

LOGFILE=$CASEDIR/create_netcdf_v1_5.$LID
time ./create_netcdf_v1_5.sh  $YEARs $YEARe $DATESTRc $ODAYe >& $LOGFILE

real	1m56.086s
user	0m9.624s
sys	7m15.993s
#  input: .../linkdir/products/version_1_5/grads
# output: .../linkdir/products/version_1_5/netCDF

#-----------------------------------------------------------------------------------------
echo " CMORized files for input4MIPs---------------------------------------------"
 CMORized files for input4MIPs---------------------------------------------
echo "tStamp: $(date +%y%m%d-%H%M%S)"
tStamp: 220301-130648
#-----------------------------------------------------------------------------------------

cd $HOMEDIR/for_omip_cmor/MRI-JMA-JRA55-do-1-5-0 
pwd
/glade/u/home/ssfcst/JRA55-do/for_omip_cmor/MRI-JMA-JRA55-do-1-5-0

sed -e s/@year@/${YEARe}/ \
    -e s/@create@/${DATESTRc}/ \
    runCmorAllWrite-1-5-0-update-atmos.py_template > runCmorAllWrite-1-5-0-update-atmos.py

# conda init
# conda activate mypy38  # BK: must set up this python env prior to running this script
python  runCmorAllWrite-1-5-0-update-atmos.py

! ------
! All files were closed successfully. 
! ------
! 

! ------
! All files were closed successfully. 
! ------
! 

! ------
! All files were closed successfully. 
! ------
! 

! ------
! All files were closed successfully. 
! ------
! 

! ------
! All files were closed successfully. 
! ------
! 

! ------
! All files were closed successfully. 
! ------
! 

! ------
! All files were closed successfully. 
! ------
! 

! ------
! All files were closed successfully. 
! ------
! 

! ------
! All files were closed successfully. 
! ------
! 
key,var: A3hr rain
filePath: input_atmos/rain.2022.20220221.nc
cmorTable: Tables/input4MIPs_A3hr.json
inputVarName: prrn
outputVarName: prra
outputUnits: kg m-2 s-1
Source data read start..
Source data read end..
Start CMORizing..
Start CMOR write..
End CMOR write..
key,var: A3hr snow
filePath: input_atmos/snow.2022.20220221.nc
cmorTable: Tables/input4MIPs_A3hr.json
inputVarName: prsn
outputVarName: prsn
outputUnits: kg m-2 s-1
Source data read start..
Source data read end..
Start CMORizing..
Start CMOR write..
End CMOR write..
key,var: A3hr rlds
filePath: input_atmos/rlds.2022.20220221.nc
cmorTable: Tables/input4MIPs_A3hr.json
inputVarName: rlds
outputVarName: rlds
outputUnits: W m-2
Source data read start..
Source data read end..
Start CMORizing..
Start CMOR write..
End CMOR write..
key,var: A3hr rsds
filePath: input_atmos/rsds.2022.20220221.nc
cmorTable: Tables/input4MIPs_A3hr.json
inputVarName: rsds
outputVarName: rsds
outputUnits: W m-2
Source data read start..
Source data read end..
Start CMORizing..
Start CMOR write..
End CMOR write..
key,var: A3hrPt q_10
filePath: input_atmos/q_10.2022.20220221.nc
cmorTable: Tables/input4MIPs_A3hrPt.json
inputVarName: huss_10m
outputVarName: huss
outputUnits: 1.0
Source data read start..
Source data read end..
Start CMORizing..
Start CMOR write..
End CMOR write..
key,var: A3hrPt slp
filePath: input_atmos/slp.2022.20220221.nc
cmorTable: Tables/input4MIPs_A3hrPt.json
inputVarName: psl
outputVarName: psl
outputUnits: Pa
Source data read start..
Source data read end..
Start CMORizing..
Start CMOR write..
End CMOR write..
key,var: A3hrPt t_10
filePath: input_atmos/t_10.2022.20220221.nc
cmorTable: Tables/input4MIPs_A3hrPt.json
inputVarName: tas_10m
outputVarName: tas
outputUnits: K
Source data read start..
Source data read end..
Start CMORizing..
Start CMOR write..
End CMOR write..
key,var: A3hrPt u_10
filePath: input_atmos/u_10.2022.20220221.nc
cmorTable: Tables/input4MIPs_A3hrPt.json
inputVarName: uas_10m
outputVarName: uas
outputUnits: m s-1
Source data read start..
Source data read end..
Start CMORizing..
Start CMOR write..
End CMOR write..
key,var: A3hrPt v_10
filePath: input_atmos/v_10.2022.20220221.nc
cmorTable: Tables/input4MIPs_A3hrPt.json
inputVarName: vas_10m
outputVarName: vas
outputUnits: m s-1
Source data read start..
Source data read end..
Start CMORizing..
Start CMOR write..
End CMOR write..

#  input: .../linkdir/products/version_1_5/netCDF
# output: .../linkdir/products/version_1_5/input4MIPs

echo ${0} "EXIT"
/glade/u/home/ssfcst/JRA55-do/cesm-scripts/JRA_step8.sh EXIT
